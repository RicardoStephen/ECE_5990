<!--
Jay Fetter and Ricardo Stephens
ECE 5990 Lab Report
-->

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<html>
<head>

	<title>ECE 5990 | Awesome Project </title>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />

	<meta name="keywords" content="Jay Fetter Ricardo Stephens Raspberry Pi" />
	<meta name="description" content="This webpage is jdf258 and rls454 awesome project report for ECE 5990 at Cornell University" />
	<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.7.0/build/reset-fonts-grids/reset-fonts-grids.css" media="all" />
	<link rel="stylesheet" type="text/css" href="CSS/report.css" media="all" />
	<link rel="stylesheet" href="CSS/project.css" type="text/css" media="screen, projection" />
</head>
<body>

<div id="doc2" class="yui-t7">
	<div id="inner">
		<div id="hd">
			<div class="yui-gc">
				<div>
				  <strong><h1 style="font-size:25px">CNPI: Improving CNC performance with a Raspberry Pi</h1></strong>
				  <h2>Jay Fetter and Ricardo Stephen</h2>
				</div>

			</div><!--// .yui-gc -->
		</div><!--// hd -->

		<div id="bd"> <!--// Main Body begins here -->
			<div id="yui-main">
				<div class="yui-b">


						<div class="yui-gf"> <!--// This is a section -->
							<div class="yui-u first">
								<h2>Introduction</h2> <!--// put your heading here -->
							</div>
							<div class="yui-u">
                            <img src="images/20160516_211446.jpg" style = "float:right; margin: 10px 10px 10px 10px;" alt="" width="40%" height="40%" title="The Okuma In All its Glory"/>
							  <p>A computerized numerical controller or CNC machine is the backbone of a modern day machine shop.
                             	
                               A CNC is a computer controlled machine that can programmed to produce a specific part. These are useful in manufacturing when a large copies of a part are needed or when a part contains geometries that are impossible to make with a manual machine.</p>
                             
							  <p><br />
							    These machines can range in price from $10k to over $1 million. One of the disparities between a “low end” CNC and a “top of the line” CNC is the accuracy at which it can make different parts. In order to insure the greatest accuracy and precision in part manufacturing, modern CNC’s rely on dynamic feedback from a variety of sensors. </p>
                                
							  <!--// Put Content here -->
							</div>
						</div><!--// Your section has ended -->

						<div class="yui-gf"> <!--// This is another section -->
							<div class="yui-u first">
								<h2>Objective</h2> <!--// put your heading here -->
							</div>
							<div class="yui-u">
							  <p>The goal of this project is to develop a low-cost supplemental add on device to a CNC system to provide similar feedback control like a more expensive machine. This would allows smaller shops to produce higher quality parts, while avoiding the significant expense of upgrading machinery. The final result of this project would be to create a sub $100 easy to use device that can easily be integrated into the machine shop environment. <br />
						      </p>
							  <!--// Put Content here -->
							</div>
						</div><!--// Your section has ended -->

						<div class="yui-gf"> <!--// This is a section -->
							<div class="yui-u first">
								<h2>Design</h2> <!--// put your heading here -->
							</div>
							<div class="yui-u">
							  <p><h2><strong>Machining Background </strong></h2></p>
							  <p>&nbsp;</p>
							  <p>In order to accomplish our goal of improving performance of “low end” CNC machines, we first had to quantify what we considered good performance. For the scope of this project, we determined that we consider high levels of chatter to be bad performance. Chatter occurs when the machine hits a self-excited level of vibration while machining a part. This can be detrimental to the surface finish of a part, tool life, and the operator's eardrums. There are many ways to reduce chatter, such as using a stiffer setup and better tools. 
                              <br />However, these are parameters that our device cannot control so we sought out other ways to reduce chatter. Other methods of reducing chatter are modifying the feeds and speeds on the machine. The feedrate is defined by how fast the machine will move over the part. The spindle speed is how fast the tool is spinning. Both of these parameters can be set in software and presented an opening that we sought to exploit to reduce chatter. </p>
							  <p><h2><strong>Hardware: (Ricardo can do this) </strong></h2></p>
							  <p>We used an Okuma Cadet V OSP5020m for testing. This machine was available to use for Blue Apron Machinists in the Emerson Machine Shop in Rhodes Hall. Since one of the group members had extensive experience working with this machine, we were able to get access to experiment on the machine without any hiccups.</p>
                <p>We also used a standard USB microphone in order to measure the amount of noise produced by the mill. The mic was capable of sampling at 44.1kHz, which is the frequency required to capture sounds audible to the human ear. This was much greater than the application requirements, since research showed that the chatter frequencies are almost always found below 2kHz.</p>
                <p>Lastly, the hardware reqired to intercept communication between the computer and the mill consisted of two RS-232

                  The Okuma mill was connected to a computer that had the necessary software to interface with the mill. The mill and the computer were connected via a DB9-to-DB25 serial connector, and in order to allow the pi to control the mill, the pi had to somehow intercept this connection. This was done using

                  at the machine shop. The computer had the software required to operate the mill. 
                Microphone RS232 Cables (Talk about the parameters) </p>
							  <p><h2><strong>Software</strong></h2>&nbsp;</p>
							  <p>Microphone and FFT </p>
							  <p>Recompiling </p>
							  <p><h2><strong>CNC Communication</strong></h2>&nbsp;<br />
						      </p>
							  <p>&nbsp;</p>
                              <div class ="image_div" style="float:right">
                             	<img class="image_float" src="images/20160516_212136.jpg" width="640" height="320" title="Pi in action" /><br />
                                Using the Pi as the go-between.
                                </div>
							  <p>Our first milestone was figuring out how to communicate with the CNC via RS-232. Initially we used a computer to act as the go between for the CNC Computer and the CNC. We used 2 USB-&gt;RS232 adapters and plugged them into a laptop. One of the RS232 went to the computer, while the other went to the CNC. This allowed the computer to intercept all communication between the two other devices without the other devices knowing that it was even there.</p>
							  <p>&nbsp;</p>
							  <p> Initially the RS232 cables we had didn’t have the correct FTDI chips in them and would not work with the CNC. We got better RS232 cables that then were able to work. We were able to send a request of a program from the CNC, capture that transmission on the computer, and then forward that transmission to the CNC computer. The CNC computer then proceeded to dripfeed the GCode program via serial through our inserted computer, which passed it to the CNC. The CNC was actually able to receive the program and run properly. (Our hands were over the emergency stop on the machine the entire time this was happening.) The next step was to accomplish this with the Pi acting as the go-between, which we were able to quickly accomplish since it just involved plugging the Pi in. </p>
							  <p>&nbsp;</p>
							  <p><h2><strong>GCode Parsing <br />
							    </strong></h2><br />
							    An important part of our project was the parsing of GCode files to be run on the CNC. This would allow us to visualize what the machine was working on and allow us to map areas of high chatter to locations on the part. In order to accomplish this task, a GCode parser was written in python. The parser is designed to keep track of important global information like the current position, feedrate, tool number, and spindle speed.</p>
							  <p>&nbsp;</p>
							  <p><h2><strong>Plotting</strong></h2></p>
							  <p>&nbsp;</p>
							  <p>An important part of our project was generating a visual from the provided gcode. This allows the machinist to visualize areas that are prone to high noise. This also allows the visualization of how the noise profile changes as the part is machined.</p>
							  <p>&nbsp;</p>
							  <p>In order to create a plot of the part being machined, the GCode parser was leveraged as well as the MatPlotLib library for python. We were able to take the parameters maintained by the parser and use them to create 3D plots of the parts being machined. This was not as simple as it sounds because these GCode programs are so long that we would be plotting 40,000+ lines per program. This was an intense memory and CPU overhead for the Pi. This was something that required a lot of testing and tuning, because there are many different ways this library works and each of them provide different performance. We were able to eventually fine tune our approach and achieve 100x speedup in our plotting compared to when we started. Microphone and FFT Recompiling <br />
						      </p>
							  <!--// Put Content here -->
							</div>
						</div><!--// Your section has ended -->

						<div class="yui-gf"> <!--// This is a section -->
							<div class="yui-u first">
								<h2>Testing</h2> <!--// put your heading here -->
							</div>
							<div class="yui-u">
							  <p><h2><strong>GCode Parser </strong></h2></p>
							  <p>&nbsp;</p>
                             
							  <p>The parser was tested with various GCode programs provided by the Cornell Baja SAE and Resistance Racing: Cornell Electric Motorcycle project teams. These programs were considered good candidates because they were quite long (~50,000 lines) and were all parts that we had access to the CADs of to check our visualization against. <br />
						      </p>
                               <figure>
                                <center>
                             	<img src="images/FSPO2.png" style = "border:thin" alt="" width="400" height="200"/>
                               <figcaption>FigXXXXX. 2D rendering generated by GCode Parser</figcaption></center>
                               </figure>
                               <figure>
                                <center>
                             	<img src="images/FSOP3D.png" style = "border:thin" alt="" width="400" height="200"/>
                               <figcaption>FigXXXXX.3D Render generated by GCode Parser</figcaption></center>
                               </figure>
                                <figure>
                                <center>
                             	<img src="images/FSOP.jpg" style = "border:thin" alt="" width="400" height="200"/>
                               <figcaption>FigXXXXX.Actual Manufactured Part</figcaption></center>
                               </figure>

							  <p>&nbsp;</p>
							  <p><h2><strong>CNC Machine</strong></h2><br />
						      </p>
							  <p>&nbsp;</p>
							  <p>The CNC machine posed a major problem while we were testing. An important part of our process was mapping noise levels received to a specific instruction. However, due to the way the CNC operates, there is no real way to know exactly which instruction is being executed at any point in time. This happens because the CNC machine buffers instructions so when the Pi would send an instruction, it doesn’t mean that the CNC is currently executing that instruction. This buffering helps the machine operate by making the transitions between instructions much smoother, but hurts the scope of our project.</p>
							  <p>&nbsp;</p>
							  <p>In order to get around this problem, we calculated the time it would take for each instruction to execute and attempted to map the time at which we experienced high noise to what instruction the Pi thought it was executing at that time. </p>
							  <!--// Put Content here -->
							</div>
						</div><!--// Your section has ended -->

						
						<div class="yui-gf"> <!--// This is a section -->
							<div class="yui-u first">
								<h2>Drawings</h2> <!--// put your heading here -->
							</div>
							<div>
							  <p>&nbsp;</p>
							  <p><br />
						      </p>
							</div>
                            <div style ="text-align: center">
<figure>
               	<img src="images/20160516_211435.jpg" alt="" width="640" height="320" title="Ricardo hard at work"/>
               	<figcaption>Fig3. - A view of the pulpit rock in Norway.</figcaption>
                             	</figure> 
                                <figure>
                             	<img src="images/20160516_210720.jpg" alt="" width="640" height="320" title="Inside the Okuma"/>
                             	<figcaption>Fig4. - A view of the pulpit rock in Norway.</figcaption>
                             	</figure> 
                           
                                 <figure>
                             	 <img src="images/Rub2.png" width="400" height="200" alt=""/>
                             	<figcaption>Fig6. - A view of the pulpit rock in Norway.</figcaption>
                             	</figure> 
                                <figure>
                                <img src="images/LiteR2.png" width="400" height="200" alt=""/>
                                <figcaption>Fig7. - A view of the pulpit rock in Norway.</figcaption>
                             	</figure>
							
                            
                           
                           
                           
                           
                            </div>
							<div class="yui-u">
							  <p>&nbsp;</p>
							  <br />
							  <p>&nbsp;</p>
							  <!--// Put Content here -->
							    </p>
							  <p> Credits to XKCD </p>
							</div>
						</div><!--// Your section has ended -->

						<div class="yui-gf"> <!--// This is a section -->
							<div class="yui-u first">
								<h2>Results</h2> <!--// put your heading here -->
							</div>
							<div class="yui-u">
								<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
								</p> <!--// Put Content here -->
							</div>
						</div><!--// Your section has ended -->

						<div class="yui-gf"> <!--// This is a section -->
							<div class="yui-u first">
								<h2>Conclusion</h2> <!--// put your heading here -->
							</div>
							<div class="yui-u">
								<p>Yay !!! Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
								</p> <!--// Put Content here -->
							</div>
						</div><!--// Your section has ended -->

					<div class="yui-gf">
						<div class="yui-u first">
							<h2>Code Appendix</h2>
						</div>
							<div class="yui-u">
                            <!-- HTML generated using hilite.me -->
                            <div>
                            <div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9 
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #888888">#!/usr/local/bin/python3</span>

<span style="color: #888888"># http://stackoverflow.com/questions/10733903/pyaudio-input-overflowed</span>

<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">pyaudio</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">wave</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">time</span>

CHUNK <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">2</span><span style="color: #333333">**</span><span style="color: #0000DD; font-weight: bold">12</span>
FORMAT<span style="color: #333333">=</span>pyaudio<span style="color: #333333">.</span>paInt16
CHANNELS <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span>
RATE <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">44100</span>
RECORD_SECONDS <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">5</span>
TIMESTAMP <span style="color: #333333">=</span> <span style="color: #007020">str</span>(<span style="color: #007020">int</span>(time<span style="color: #333333">.</span>time()))
WAVE_OUTPUT_FILENAME <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;audio/async&quot;</span><span style="color: #333333">+</span>TIMESTAMP<span style="color: #333333">+</span><span style="background-color: #fff0f0">&quot;.wav&quot;</span>

wf <span style="color: #333333">=</span> wave<span style="color: #333333">.</span>open(WAVE_OUTPUT_FILENAME, <span style="background-color: #fff0f0">&#39;wb&#39;</span>)
wf<span style="color: #333333">.</span>setnchannels(CHANNELS)
wf<span style="color: #333333">.</span>setsampwidth(<span style="color: #0000DD; font-weight: bold">2</span>)
wf<span style="color: #333333">.</span>setframerate(RATE)

end_signal <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">callback</span>(in_data, frame_count, time_info, status):
    <span style="color: #008800; font-weight: bold">global</span> end_signal
    <span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Callback&quot;</span>)
    wf<span style="color: #333333">.</span>writeframes(in_data)
    <span style="color: #008800; font-weight: bold">if</span>(end_signal <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">1</span>):
        wf<span style="color: #333333">.</span>close()
        <span style="color: #007020">exit</span>()
    <span style="color: #008800; font-weight: bold">else</span>:
        <span style="color: #008800; font-weight: bold">return</span>(in_data, pyaudio<span style="color: #333333">.</span>paContinue)

p<span style="color: #333333">=</span>pyaudio<span style="color: #333333">.</span>PyAudio()

inStream <span style="color: #333333">=</span> p<span style="color: #333333">.</span>open(format <span style="color: #333333">=</span> FORMAT,
                  channels<span style="color: #333333">=</span>CHANNELS,
                  rate<span style="color: #333333">=</span>RATE,
                  <span style="color: #007020">input</span><span style="color: #333333">=</span><span style="color: #007020">True</span>,
                  output<span style="color: #333333">=</span><span style="color: #007020">True</span>,
                  frames_per_buffer<span style="color: #333333">=</span>CHUNK,
                  stream_callback<span style="color: #333333">=</span>callback)

<span style="color: #008800; font-weight: bold">while</span> <span style="color: #007020">True</span>:
    <span style="color: #008800; font-weight: bold">try</span>:
        <span style="color: #008800; font-weight: bold">continue</span>
    <span style="color: #008800; font-weight: bold">except</span> <span style="color: #FF0000; font-weight: bold">KeyboardInterrupt</span>:
        end_signal <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span>
</pre></td></tr></table></div>
<h2><strong><center>pyaudio_asynch.py<br /></center></strong><br /></h2>
							<!-- This is a good idea. HTML generated using hilite.me -->
                      <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28 
29
30
31
32
33
34
35
36
37
38
39
40</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">pyaudio</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">wave</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">time</span>

CHUNK <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">2000</span>
FORMAT <span style="color: #333333">=</span> pyaudio<span style="color: #333333">.</span>paInt16
CHANNELS <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span>
RATE <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">2000</span>
RECORD_SECONDS <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">5</span>
TIMESTAMP <span style="color: #333333">=</span> <span style="color: #007020">str</span>(<span style="color: #007020">int</span>(time<span style="color: #333333">.</span>time()))
WAVE_OUTPUT_FILENAME <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;audio/output&quot;</span><span style="color: #333333">+</span>TIMESTAMP<span style="color: #333333">+</span><span style="background-color: #fff0f0">&quot;.wav&quot;</span>

p <span style="color: #333333">=</span> pyaudio<span style="color: #333333">.</span>PyAudio()

stream <span style="color: #333333">=</span> p<span style="color: #333333">.</span>open(format<span style="color: #333333">=</span>FORMAT,
                channels<span style="color: #333333">=</span>CHANNELS,
                rate<span style="color: #333333">=</span>RATE,
                <span style="color: #007020">input</span><span style="color: #333333">=</span><span style="color: #007020">True</span>,
                frames_per_buffer<span style="color: #333333">=</span>CHUNK)

<span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;* recording&quot;</span>)

frames <span style="color: #333333">=</span> []

<span style="color: #008800; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">range</span>(<span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #007020">int</span>(RATE <span style="color: #333333">/</span> CHUNK <span style="color: #333333">*</span> RECORD_SECONDS)):
        data <span style="color: #333333">=</span> stream<span style="color: #333333">.</span>read(CHUNK)
        frames<span style="color: #333333">.</span>append(data)

<span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;* done recording&quot;</span>)

stream<span style="color: #333333">.</span>stop_stream()
stream<span style="color: #333333">.</span>close()
p<span style="color: #333333">.</span>terminate()

wf <span style="color: #333333">=</span> wave<span style="color: #333333">.</span>open(WAVE_OUTPUT_FILENAME, <span style="background-color: #fff0f0">&#39;wb&#39;</span>)
wf<span style="color: #333333">.</span>setnchannels(CHANNELS)
wf<span style="color: #333333">.</span>setsampwidth(p<span style="color: #333333">.</span>get_sample_size(FORMAT))
wf<span style="color: #333333">.</span>setframerate(RATE)
wf<span style="color: #333333">.</span>writeframes(b<span style="background-color: #fff0f0">&#39;&#39;</span><span style="color: #333333">.</span>join(frames))
wf<span style="color: #333333">.</span>close()
</pre></td></tr></table></div>
<h2><strong><center>pyaudio_record.py<br /></center></strong><br /></h2>
<!-- END of pyaudio_record.py-->
<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%"> 1
 2
  3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #888888">#http://glowingpython.blogspot.ro/2011/08/how-to-plot-frequency-spectrum-with.html</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">pylab</span> <span style="color: #008800; font-weight: bold">import</span> plot, show, title, xlabel, ylabel, subplot, savefig
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">scipy</span> <span style="color: #008800; font-weight: bold">import</span> fft, arange, ifft
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">numpy</span> <span style="color: #008800; font-weight: bold">import</span> sin, linspace, pi
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">scipy.io.wavfile</span> <span style="color: #008800; font-weight: bold">import</span> read,write

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">plotSpectru</span>(y,Fs):
 n <span style="color: #333333">=</span> <span style="color: #007020">len</span>(y) <span style="color: #888888"># lungime semnal</span>
 k <span style="color: #333333">=</span> arange(n)
 T <span style="color: #333333">=</span> n<span style="color: #333333">/</span>Fs
 frq <span style="color: #333333">=</span> k<span style="color: #333333">/</span>T <span style="color: #888888"># two sides frequency range</span>
 frq <span style="color: #333333">=</span> frq[<span style="color: #007020">range</span>(n<span style="color: #333333">/</span><span style="color: #0000DD; font-weight: bold">2</span>)] <span style="color: #888888"># one side frequency range</span>

 Y <span style="color: #333333">=</span> fft(y)<span style="color: #333333">/</span>n <span style="color: #888888"># fft computing and normalization</span>
 Y <span style="color: #333333">=</span> Y[<span style="color: #007020">range</span>(n<span style="color: #333333">/</span><span style="color: #0000DD; font-weight: bold">2</span>)]
 
 plot(frq,<span style="color: #007020">abs</span>(Y),<span style="background-color: #fff0f0">&#39;r&#39;</span>) <span style="color: #888888"># plotting the spectrum</span>
 xlabel(<span style="background-color: #fff0f0">&#39;Freq (Hz)&#39;</span>)
 ylabel(<span style="background-color: #fff0f0">&#39;|Y(freq)|&#39;</span>)


Fs,data<span style="color: #333333">=</span>read(<span style="background-color: #fff0f0">&#39;audio/test2.wav&#39;</span>)

y<span style="color: #333333">=</span>data[:,<span style="color: #0000DD; font-weight: bold">1</span>]
lungime<span style="color: #333333">=</span><span style="color: #007020">len</span>(y)
timp<span style="color: #333333">=</span><span style="color: #007020">len</span>(y)<span style="color: #333333">/</span>Fs
t<span style="color: #333333">=</span>linspace(<span style="color: #0000DD; font-weight: bold">0</span>,timp,<span style="color: #007020">len</span>(y))

subplot(<span style="color: #0000DD; font-weight: bold">2</span>,<span style="color: #0000DD; font-weight: bold">1</span>,<span style="color: #0000DD; font-weight: bold">1</span>)
plot(t,y)
xlabel(<span style="background-color: #fff0f0">&#39;Time&#39;</span>)
ylabel(<span style="background-color: #fff0f0">&#39;Amplitude&#39;</span>)
subplot(<span style="color: #0000DD; font-weight: bold">2</span>,<span style="color: #0000DD; font-weight: bold">1</span>,<span style="color: #0000DD; font-weight: bold">2</span>)
plotSpectru(y,Fs)
show()
</pre></td></tr></table></div>
<h2><strong><center>cnc_fft.py<br /></center></strong><br /></h2>
<!-- End of cnc_fft.py-->
<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">  1
  2
  3
  4
  5 
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #888888">#!/usr/bin/python</span>
<span style="color: #888888"># This is the main gcode parser for the project.</span>
<span style="color: #888888"># Rev. 1.0 will take in static Gcode files and parse them</span>
<span style="color: #888888"># Rev. 2.0 will take in the Gcode dynamically via Serial</span>
<span style="color: #888888">#</span>


<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">sys</span><span style="color: #333333">,</span> <span style="color: #0e84b5; font-weight: bold">fileinput</span><span style="color: #333333">,</span> <span style="color: #0e84b5; font-weight: bold">math</span><span style="color: #333333">,</span> <span style="color: #0e84b5; font-weight: bold">re</span>
<span style="color: #888888"># -*- coding: utf-8 -*-</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">numpy</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">np</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">matplotlib</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">plt</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">matplotlib.patches</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">mpatches</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">mpl_toolkits.mplot3d.axes3d</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">p3</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">matplotlib.animation</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">animation</span>
<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">matplotlib</span> <span style="color: #008800; font-weight: bold">import</span> cm, colors, patches


prevX          <span style="color: #333333">=</span> <span style="color: #007020">float</span>(<span style="color: #6600EE; font-weight: bold">0.0</span>)
prevY          <span style="color: #333333">=</span> <span style="color: #007020">float</span>(<span style="color: #6600EE; font-weight: bold">0.0</span>)
prevZ          <span style="color: #333333">=</span> <span style="color: #007020">float</span>(<span style="color: #6600EE; font-weight: bold">0.0</span>)
globalX        <span style="color: #333333">=</span> <span style="color: #007020">float</span>(<span style="color: #6600EE; font-weight: bold">0.0</span>)
globalY        <span style="color: #333333">=</span> <span style="color: #007020">float</span>(<span style="color: #6600EE; font-weight: bold">0.0</span>)
globalZ        <span style="color: #333333">=</span> <span style="color: #007020">float</span>(<span style="color: #6600EE; font-weight: bold">0.0</span>)
globalI        <span style="color: #333333">=</span> <span style="color: #007020">float</span>(<span style="color: #6600EE; font-weight: bold">0.0</span>)
globalJ        <span style="color: #333333">=</span> <span style="color: #007020">float</span>(<span style="color: #6600EE; font-weight: bold">0.0</span>)
feedRate       <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
spindleSpeed   <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
toolNum        <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">19</span>
toolSize       <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
rapid          <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">100</span>
toolChangeTime <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">5</span><span style="color: #333333">/</span><span style="color: #0000DD; font-weight: bold">60</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">parseM</span>(line, index):
    index <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>
    <span style="color: #008800; font-weight: bold">return</span> index

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">parseX</span>(line, index):
    <span style="color: #008800; font-weight: bold">global</span> globalX
    <span style="color: #008800; font-weight: bold">if</span>(<span style="color: #000000; font-weight: bold">not</span> line[index][<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;X&#39;</span>):
        <span style="color: #007020">exit</span>(<span style="color: #0000DD; font-weight: bold">1</span>)
    prevX <span style="color: #333333">=</span> globalX
    globalX <span style="color: #333333">=</span> <span style="color: #007020">float</span>(line[index][<span style="color: #0000DD; font-weight: bold">1</span>:])
    <span style="color: #888888">#print(&quot;Parsing X: %f\n&quot;) % globalX</span>
    index <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>
    <span style="color: #008800; font-weight: bold">return</span> index

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">parseY</span>(line, index):
    <span style="color: #008800; font-weight: bold">global</span> globalY
    <span style="color: #008800; font-weight: bold">if</span>(<span style="color: #000000; font-weight: bold">not</span> line[index][<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;Y&#39;</span>):
        <span style="color: #007020">exit</span>(<span style="color: #0000DD; font-weight: bold">1</span>)
    prevY <span style="color: #333333">=</span> globalY
    globalY <span style="color: #333333">=</span> <span style="color: #007020">float</span>(line[index][<span style="color: #0000DD; font-weight: bold">1</span>:])
    <span style="color: #888888">#print(&quot;Parsing Y: %f\n&quot;) % globalY</span>
    index <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>
    <span style="color: #008800; font-weight: bold">return</span> index

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">parseZ</span>(line, index):
    <span style="color: #008800; font-weight: bold">global</span> globalZ
    <span style="color: #008800; font-weight: bold">if</span>(<span style="color: #000000; font-weight: bold">not</span> line[index][<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;Z&#39;</span>):
        <span style="color: #007020">exit</span>(<span style="color: #0000DD; font-weight: bold">1</span>)
    prevZ <span style="color: #333333">=</span> globalZ
    globalZ <span style="color: #333333">=</span> <span style="color: #007020">float</span>(line[index][<span style="color: #0000DD; font-weight: bold">1</span>:])
    <span style="color: #888888">#print(&quot;Parsing Z: %f\n&quot;) % globalZ</span>
    index <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>
    <span style="color: #008800; font-weight: bold">return</span> index

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">parseI</span>(line, index):
    <span style="color: #008800; font-weight: bold">global</span> globalI
    <span style="color: #008800; font-weight: bold">if</span>(<span style="color: #000000; font-weight: bold">not</span> line[index][<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;I&#39;</span>):
        <span style="color: #007020">exit</span>(<span style="color: #0000DD; font-weight: bold">1</span>)
    globalI <span style="color: #333333">=</span> <span style="color: #007020">float</span>(line[index][<span style="color: #0000DD; font-weight: bold">1</span>:])
    <span style="color: #888888">#print(&quot;Parsing Z: %f\n&quot;) % globalZ</span>
    index <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>
    <span style="color: #008800; font-weight: bold">return</span> index
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">parseJ</span>(line, index):
    <span style="color: #008800; font-weight: bold">global</span> globalJ
    <span style="color: #008800; font-weight: bold">if</span>(<span style="color: #000000; font-weight: bold">not</span> line[index][<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;J&#39;</span>):
        <span style="color: #007020">exit</span>(<span style="color: #0000DD; font-weight: bold">1</span>)
    globalJ <span style="color: #333333">=</span> <span style="color: #007020">float</span>(line[index][<span style="color: #0000DD; font-weight: bold">1</span>:])
    <span style="color: #888888">#print(&quot;Parsing Z: %f\n&quot;) % globalZ</span>
    index <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>
    <span style="color: #008800; font-weight: bold">return</span> index

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">parseG0</span>(line, index):
    <span style="color: #008800; font-weight: bold">while</span>(index <span style="color: #333333">&lt;</span> <span style="color: #007020">len</span>(line) <span style="color: #000000; font-weight: bold">and</span> <span style="color: #000000; font-weight: bold">not</span> (line[index] <span style="color: #000000; font-weight: bold">in</span> validCmds)):
        index <span style="color: #333333">=</span> validDirections[line[index][<span style="color: #0000DD; font-weight: bold">0</span>]](line, index)
    <span style="color: #008800; font-weight: bold">return</span> index


<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">parseG1</span>(line, index):
   <span style="color: #008800; font-weight: bold">while</span>(index <span style="color: #333333">&lt;</span> <span style="color: #007020">len</span>(line) <span style="color: #000000; font-weight: bold">and</span> <span style="color: #000000; font-weight: bold">not</span> (line[index][<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #000000; font-weight: bold">in</span> validCmds)):
        index <span style="color: #333333">=</span> validDirections[line[index][<span style="color: #0000DD; font-weight: bold">0</span>]](line, index)
    <span style="color: #008800; font-weight: bold">return</span> index

<span style="color: #888888">#Circular Move CCW</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">parseG2</span>(line, index):
    <span style="color: #008800; font-weight: bold">while</span>(index <span style="color: #333333">&lt;</span> <span style="color: #007020">len</span>(line) <span style="color: #000000; font-weight: bold">and</span> <span style="color: #000000; font-weight: bold">not</span> (line[index][<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #000000; font-weight: bold">in</span> validCmds)):
        index <span style="color: #333333">=</span> validDirections[line[index][<span style="color: #0000DD; font-weight: bold">0</span>]](line, index)
    <span style="color: #008800; font-weight: bold">return</span> index
<span style="color: #888888">#Circular Move CW: IJ=centerpoint, XY = endpoints</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">parseG3</span>(line, index):
    <span style="color: #008800; font-weight: bold">while</span>(index <span style="color: #333333">&lt;</span> <span style="color: #007020">len</span>(line) <span style="color: #000000; font-weight: bold">and</span> <span style="color: #000000; font-weight: bold">not</span> (line[index][<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #000000; font-weight: bold">in</span> validCmds)):
        index <span style="color: #333333">=</span> validDirections[line[index][<span style="color: #0000DD; font-weight: bold">0</span>]](line, index)
    <span style="color: #008800; font-weight: bold">return</span> index

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">parseG</span>(line, index):
    <span style="color: #008800; font-weight: bold">global</span> movementType
    <span style="color: #888888">#print(&quot;Found a valid G cmd: %s. Index: %d\n&quot;) % (line, index)</span>
    <span style="color: #008800; font-weight: bold">if</span>(<span style="color: #000000; font-weight: bold">not</span> line[index][<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;G&#39;</span>):
        <span style="color: #007020">exit</span>(<span style="color: #0000DD; font-weight: bold">1</span>)
    index <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>
    <span style="color: #008800; font-weight: bold">if</span>(line[index<span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>] <span style="color: #000000; font-weight: bold">in</span> validGCmds):
        movementType <span style="color: #333333">=</span> line[index<span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>]
        index <span style="color: #333333">=</span> validGCmds[line[index<span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>]](line, index)
    <span style="color: #008800; font-weight: bold">return</span> index

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">parseT</span>(line, index):
    <span style="color: #008800; font-weight: bold">global</span> toolNum
    <span style="color: #008800; font-weight: bold">if</span>(<span style="color: #000000; font-weight: bold">not</span> line[index][<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;T&#39;</span>):
        <span style="color: #007020">exit</span>(<span style="color: #0000DD; font-weight: bold">1</span>)
    <span style="color: #008800; font-weight: bold">if</span>(<span style="color: #007020">len</span>(line[index]) <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">1</span>):
        toolNum <span style="color: #333333">=</span> <span style="color: #007020">int</span>(line[index<span style="color: #333333">+</span><span style="color: #0000DD; font-weight: bold">1</span>])
        index <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">2</span>
    <span style="color: #008800; font-weight: bold">else</span>:
        toolNum <span style="color: #333333">=</span> <span style="color: #007020">int</span>(line[index][<span style="color: #0000DD; font-weight: bold">1</span>:])
        index <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>
    <span style="color: #008800; font-weight: bold">return</span> index
<span style="color: #888888">#assume its in the format for now: S#####</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">parseSpindle</span>(line, index):
    <span style="color: #008800; font-weight: bold">global</span> spindleSpeed
    <span style="color: #888888">#print(&quot;Found a valid spindle: Here is the line: %s\n&quot;) % line</span>
    <span style="color: #888888">#If this happens, throw an error</span>
    <span style="color: #008800; font-weight: bold">if</span>(<span style="color: #000000; font-weight: bold">not</span> line[index][<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;S&#39;</span>):
        <span style="color: #007020">exit</span>(<span style="color: #0000DD; font-weight: bold">1</span>)
    <span style="color: #008800; font-weight: bold">if</span>(<span style="color: #007020">len</span>(line[index]) <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">1</span>):
        spindleSpeed <span style="color: #333333">=</span> <span style="color: #007020">int</span>(line[index<span style="color: #333333">+</span><span style="color: #0000DD; font-weight: bold">1</span>])
        index <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">2</span>
    <span style="color: #008800; font-weight: bold">else</span>:
        spindleSpeed <span style="color: #333333">=</span> <span style="color: #007020">int</span>(line[index][<span style="color: #0000DD; font-weight: bold">1</span>:])
        index <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>
    <span style="color: #888888">#print(&quot;Here is the new spindleSpeed: %s\n&quot;) % spindleSpeed</span>
    <span style="color: #008800; font-weight: bold">return</span> index

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">parseFeed</span>(line, index):
    <span style="color: #008800; font-weight: bold">global</span> feedRate
    <span style="color: #888888">#print(&quot;Found a valid feedRate: Here is the line: %s\n&quot;) % line</span>
    <span style="color: #008800; font-weight: bold">if</span>(<span style="color: #000000; font-weight: bold">not</span> line[index][<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;F&#39;</span>):
        <span style="color: #007020">exit</span>(<span style="color: #0000DD; font-weight: bold">1</span>)
    <span style="color: #008800; font-weight: bold">if</span>(<span style="color: #007020">len</span>(line[index]) <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">1</span>):
        feedRate <span style="color: #333333">=</span> <span style="color: #007020">float</span>(line[index<span style="color: #333333">+</span><span style="color: #0000DD; font-weight: bold">1</span>])
        index <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">2</span>
    <span style="color: #008800; font-weight: bold">else</span>:
        feedRate <span style="color: #333333">=</span> <span style="color: #007020">float</span>(line[index][<span style="color: #0000DD; font-weight: bold">1</span>:])
        index <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>
    <span style="color: #008800; font-weight: bold">return</span> index

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">parseComment</span>(line, index):
    <span style="color: #888888">#print(&quot;Found a comment: %s\n&quot;) % line[index:]</span>
    i <span style="color: #333333">=</span> index
    <span style="color: #008800; font-weight: bold">while</span> ( i <span style="color: #333333">&lt;</span> <span style="color: #007020">len</span>(line)):
        i <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>
        <span style="color: #008800; font-weight: bold">if</span> <span style="background-color: #fff0f0">&#39;)&#39;</span> <span style="color: #000000; font-weight: bold">in</span> line[i<span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>]:
            <span style="color: #888888">#print(&quot;Found end of the comment: %s\n&quot;) % line[i-1]</span>
            <span style="color: #008800; font-weight: bold">return</span> i
validCmds       <span style="color: #333333">=</span> {<span style="background-color: #fff0f0">&#39;G&#39;</span>:parseG, <span style="background-color: #fff0f0">&#39;M&#39;</span>:parseM, <span style="background-color: #fff0f0">&#39;T&#39;</span>:parseT, <span style="background-color: #fff0f0">&#39;S&#39;</span>:parseSpindle, <span style="background-color: #fff0f0">&#39;F&#39;</span>:parseFeed,
            <span style="background-color: #fff0f0">&#39;(&#39;</span>: parseComment}
validDirections <span style="color: #333333">=</span> {<span style="background-color: #fff0f0">&#39;X&#39;</span>: parseX, <span style="background-color: #fff0f0">&#39;Y&#39;</span>:parseY, <span style="background-color: #fff0f0">&#39;Z&#39;</span>: parseZ, <span style="background-color: #fff0f0">&#39;I&#39;</span>: parseI, <span style="background-color: #fff0f0">&#39;J&#39;</span>:parseJ}
validGCmds      <span style="color: #333333">=</span> {  <span style="background-color: #fff0f0">&#39;G00&#39;</span>:parseG0, <span style="background-color: #fff0f0">&#39;G0&#39;</span>: parseG0,
                <span style="background-color: #fff0f0">&#39;G01&#39;</span>:parseG1, <span style="background-color: #fff0f0">&#39;G1&#39;</span>:parseG1,
                <span style="background-color: #fff0f0">&#39;G02&#39;</span>:parseG2, <span style="background-color: #fff0f0">&#39;G2&#39;</span>:parseG2,
                <span style="background-color: #fff0f0">&#39;G03&#39;</span>:parseG3, <span style="background-color: #fff0f0">&#39;G3&#39;</span>:parseG3}
<span style="color: #DD4422">&#39;&#39;&#39;</span>
<span style="color: #DD4422">validMCmds      = {  &#39;M03&#39;:parseM3, &#39;M3&#39;: parseM3,</span>
<span style="color: #DD4422">                &#39;M05&#39;:parseM5, &#39;M5&#39;:parseM5,</span>
<span style="color: #DD4422">                &#39;M06&#39;:parseM6, &#39;M6&#39;:parseM6,</span>
<span style="color: #DD4422">                &#39;M08&#39;:parseM8, &#39;M8&#39;:parseM8}</span>
<span style="color: #DD4422">&#39;&#39;&#39;</span>

<span style="color: #888888">#Movement Type:</span>
<span style="color: #888888">#Sticks with whatever the last movement type was</span>
<span style="color: #888888">#So if the last command to specify movement was g1</span>
<span style="color: #888888">#Then an X____Y____ will really mean: G1 X______Y_____</span>
movementType <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;&#39;</span>

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">parseLine</span>(line):
    i <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
    <span style="color: #008800; font-weight: bold">while</span>( i <span style="color: #333333">&lt;</span> <span style="color: #007020">len</span>(line)):
        <span style="color: #888888">#print(&quot;This is the index Value: %d\n&quot;) % i</span>
        a <span style="color: #333333">=</span> <span style="color: #007020">str</span>(line[i][<span style="color: #0000DD; font-weight: bold">0</span>])<span style="color: #333333">.</span>split()[<span style="color: #0000DD; font-weight: bold">0</span>]
        <span style="color: #888888">#print(&quot;a: %s\n&quot;) % a</span>
        <span style="color: #008800; font-weight: bold">if</span>( a <span style="color: #000000; font-weight: bold">in</span> validCmds):
            <span style="color: #888888">#print(&quot;Is a valid cmd: %s\n&quot;) % a</span>
            i <span style="color: #333333">=</span> validCmds[a](line,i)
        <span style="color: #008800; font-weight: bold">elif</span>( a[<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #000000; font-weight: bold">in</span> validDirections <span style="color: #000000; font-weight: bold">and</span> re<span style="color: #333333">.</span>match(<span style="background-color: #fff0f0">r&quot;^([-]?\d+\.?\d+)$&quot;</span>,line[i][<span style="color: #0000DD; font-weight: bold">1</span>:]) <span style="color: #000000; font-weight: bold">is</span> <span style="color: #000000; font-weight: bold">not</span> <span style="color: #007020">None</span>):
            i <span style="color: #333333">=</span> validGCmds[movementType](line,i)
        <span style="color: #008800; font-weight: bold">else</span>:
            i <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>
plot_scale <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span>

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">calc_line</span>(x1, y1, x2, y2):
    <span style="color: #008800; font-weight: bold">if</span>(x2 <span style="color: #333333">-</span> x1 <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span>):
        slope <span style="color: #333333">=</span> <span style="color: #007020">float</span>(<span style="background-color: #fff0f0">&quot;inf&quot;</span>)
    <span style="color: #008800; font-weight: bold">else</span>:
        slope <span style="color: #333333">=</span> (y2<span style="color: #333333">-</span>y1)<span style="color: #333333">/</span>(x2<span style="color: #333333">-</span>x1)
    intercept <span style="color: #333333">=</span> y2 <span style="color: #333333">-</span> slope<span style="color: #333333">*</span>x2
    <span style="color: #008800; font-weight: bold">return</span> (slope, intercept)
    
<span style="color: #888888">#returns the distance between point 1 and point 2</span>
<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">calcDistance</span>(x1, y1, z1, x2, y2, z2):
    <span style="color: #008800; font-weight: bold">global</span> plot_scale
    <span style="color: #008800; font-weight: bold">return</span> math<span style="color: #333333">.</span>sqrt((x2<span style="color: #333333">-</span>x1)<span style="color: #333333">**</span><span style="color: #0000DD; font-weight: bold">2</span> <span style="color: #333333">+</span> (y2<span style="color: #333333">-</span>y1)<span style="color: #333333">**</span><span style="color: #0000DD; font-weight: bold">2</span> <span style="color: #333333">+</span> (z2<span style="color: #333333">-</span>z1)<span style="color: #333333">**</span><span style="color: #0000DD; font-weight: bold">2</span>)

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">calcTime</span>(distance, feedRate):
    <span style="color: #008800; font-weight: bold">if</span>(feedRate <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span>):
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">0</span>
    <span style="color: #008800; font-weight: bold">return</span> distance<span style="color: #333333">/</span>feedRate

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">point_under</span>(point, line):
    slope, intercept <span style="color: #333333">=</span> line
    <span style="color: #008800; font-weight: bold">if</span>(slope <span style="color: #333333">!=</span> <span style="color: #007020">float</span>(<span style="background-color: #fff0f0">&quot;inf&quot;</span>)):
        <span style="color: #008800; font-weight: bold">return</span> point[<span style="color: #0000DD; font-weight: bold">0</span>]<span style="color: #333333">*</span>slope <span style="color: #333333">+</span> intercept <span style="color: #333333">&gt;</span> point[<span style="color: #0000DD; font-weight: bold">1</span>]
    <span style="color: #008800; font-weight: bold">else</span>:
        <span style="color: #008800; font-weight: bold">return</span> point[<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #333333">&lt;</span> intercept

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">point_over</span>(point, line):
    slope, intercept <span style="color: #333333">=</span> line
    <span style="color: #008800; font-weight: bold">if</span>(slope <span style="color: #333333">!=</span> <span style="color: #007020">float</span>(<span style="background-color: #fff0f0">&quot;inf&quot;</span>)):
        <span style="color: #008800; font-weight: bold">return</span> point[<span style="color: #0000DD; font-weight: bold">0</span>]<span style="color: #333333">*</span>slope <span style="color: #333333">+</span> intercept <span style="color: #333333">&lt;</span> point[<span style="color: #0000DD; font-weight: bold">1</span>]
    <span style="color: #008800; font-weight: bold">else</span>:
        <span style="color: #008800; font-weight: bold">return</span> point[<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #333333">&gt;</span> intercept

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">law_of_cosines</span>(A_X, A_Y, B_X, B_Y, C_X, C_Y):
    <span style="color: #888888">#CNC doesn&#39;t do 3D arcs</span>
    a <span style="color: #333333">=</span> calcDistance(B_X, B_Y, <span style="color: #0000DD; font-weight: bold">0</span>, C_X, C_Y, <span style="color: #0000DD; font-weight: bold">0</span>)
    b <span style="color: #333333">=</span> calcDistance(A_X, A_Y, <span style="color: #0000DD; font-weight: bold">0</span>, C_X, C_Y, <span style="color: #0000DD; font-weight: bold">0</span>)
    c <span style="color: #333333">=</span> calcDistance(A_X, A_Y, <span style="color: #0000DD; font-weight: bold">0</span>, B_X, B_Y, <span style="color: #0000DD; font-weight: bold">0</span>)
    angle <span style="color: #333333">=</span> math<span style="color: #333333">.</span>acos((b<span style="color: #333333">*</span>b<span style="color: #333333">+</span> b<span style="color: #333333">*</span>b <span style="color: #333333">-</span> a<span style="color: #333333">*</span>a)<span style="color: #333333">/</span>(<span style="color: #0000DD; font-weight: bold">2</span><span style="color: #333333">*</span>b<span style="color: #333333">*</span>b))
    <span style="color: #008800; font-weight: bold">if</span>(point_over([B_X, B_Y], calc_line(C_X, C_Y, A_X, A_Y))):
        angle <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">2</span><span style="color: #333333">*</span>math<span style="color: #333333">.</span>pi<span style="color: #333333">-</span>angle
    <span style="color: #008800; font-weight: bold">return</span> (angle,angle<span style="color: #333333">*</span>b)

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">drawArc</span>():
    <span style="color: #008800; font-weight: bold">global</span>  globalX,  globalY, globalZ, globalI, globalJ, prevX, prevY
    center <span style="color: #333333">=</span> [prevX <span style="color: #333333">+</span> globalI, prevY<span style="color: #333333">+</span>globalJ]
    radius <span style="color: #333333">=</span> calcDistance(globalX, globalY, globalZ, center[<span style="color: #0000DD; font-weight: bold">0</span>], center[<span style="color: #0000DD; font-weight: bold">1</span>], prevZ)
    (angle, length) <span style="color: #333333">=</span> law_of_cosines(center[<span style="color: #0000DD; font-weight: bold">0</span>], center[<span style="color: #0000DD; font-weight: bold">1</span>], globalX, globalY, prevX, prevY)
    <span style="color: #888888">#Slope is just really globalJ/globalY</span>
    <span style="color: #008800; font-weight: bold">return</span> (center, radius, angle, length)

<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">parseFile</span>(fileName):
    <span style="color: #008800; font-weight: bold">with</span> <span style="color: #007020">open</span>(fileName) <span style="color: #008800; font-weight: bold">as</span> <span style="color: #007020">file</span>:
        <span style="color: #008800; font-weight: bold">global</span> plot_scale
        <span style="color: #008800; font-weight: bold">global</span>  globalX,  globalY, globalZ, globalI, globalJ, feedRate, spindleSpeed, toolNum, toolSize, rapid
        <span style="color: #008800; font-weight: bold">global</span> prevX, prevY, prevZ
        total_time <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
        lineNum    <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
        text       <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;&#39;</span>
        count      <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
        add        <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&#39;&#39;</span>
        prevTool   <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">19</span>
        first_time <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span>
        arcs       <span style="color: #333333">=</span> []
        lines      <span style="color: #333333">=</span> []
        fig <span style="color: #333333">=</span> plt<span style="color: #333333">.</span>figure()
        ax <span style="color: #333333">=</span> p3<span style="color: #333333">.</span>Axes3D(fig)
        <span style="color: #008800; font-weight: bold">for</span> line <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">file</span>:
            lineNum  <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>
            gcode     <span style="color: #333333">=</span> line<span style="color: #333333">.</span>upper()<span style="color: #333333">.</span>split()
            parseLine(gcode)
            time       <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
            local_feed <span style="color: #333333">=</span> feedRate
            distance   <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
            <span style="color: #008800; font-weight: bold">if</span>(movementType <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;G02&#39;</span> <span style="color: #000000; font-weight: bold">or</span> movementType <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;G2&#39;</span>):
                center, radius, angle, length <span style="color: #333333">=</span> drawArc()
                distance                      <span style="color: #333333">=</span> length
                arcs<span style="color: #333333">.</span>append(((globalX,globalY,globalZ),(prevX,prevY,prevZ),radius))
            <span style="color: #008800; font-weight: bold">elif</span>(movementType <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;G03&#39;</span> <span style="color: #000000; font-weight: bold">or</span> movementType <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;G3&#39;</span>):
                center, radius, angle, length <span style="color: #333333">=</span> drawArc()
                distance                      <span style="color: #333333">=</span> length
                arcs<span style="color: #333333">.</span>append(((prevX,prevY,prevZ),(globalX, globalY, globalZ), radius))
            <span style="color: #008800; font-weight: bold">elif</span>(movementType <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;G00&#39;</span> <span style="color: #000000; font-weight: bold">or</span> movementType <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;G0&#39;</span>):
                distance <span style="color: #333333">=</span> calcDistance(globalX, globalY, globalZ, prevX, prevY, prevZ)
                lines<span style="color: #333333">.</span>append(((prevX, prevY, prevZ), (globalX, globalY, globalZ)))
                local_feed <span style="color: #333333">=</span> rapid
                line1 <span style="color: #333333">=</span> [(prevX, prevY), (globalX, globalY)]
                (line1_xs, line1_ys) <span style="color: #333333">=</span> <span style="color: #007020">zip</span>(<span style="color: #333333">*</span>line1)
                <span style="color: #008800; font-weight: bold">if</span>(first_time <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span>):
                    ax<span style="color: #333333">.</span>plot((prevX, globalX), (prevY, globalY), (prevZ, globalZ))
                <span style="color: #008800; font-weight: bold">else</span>:
                    first_time <span style="color: #333333">-=</span> <span style="color: #0000DD; font-weight: bold">1</span>
            <span style="color: #008800; font-weight: bold">elif</span>(movementType <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;G01&#39;</span> <span style="color: #000000; font-weight: bold">or</span> movementType <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;G1&#39;</span>):
                distance <span style="color: #333333">=</span> calcDistance(globalX, globalY, globalZ, prevX, prevY, prevZ)
                lines<span style="color: #333333">.</span>append(((prevX, prevY, prevZ), (globalX, globalY, globalZ)))
                line1 <span style="color: #333333">=</span> [(prevX, prevY), (globalX, globalY)]
                (line1_xs, line1_ys) <span style="color: #333333">=</span> <span style="color: #007020">zip</span>(<span style="color: #333333">*</span>line1)
                <span style="color: #008800; font-weight: bold">if</span>(first_time <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span>):
                    ax<span style="color: #333333">.</span>plot((prevX, globalX), (prevY, globalY), (prevZ, globalZ))
                <span style="color: #008800; font-weight: bold">else</span>:
                    first_time <span style="color: #333333">-=</span> <span style="color: #0000DD; font-weight: bold">1</span>
            <span style="color: #008800; font-weight: bold">if</span>(prevTool <span style="color: #333333">!=</span> toolNum):
                total_time <span style="color: #333333">+=</span> toolChangeTime
                prevTool    <span style="color: #333333">=</span> toolNum
            time  <span style="color: #333333">=</span> calcTime(distance, local_feed)
            total_time <span style="color: #333333">+=</span> time
            prevX <span style="color: #333333">=</span> globalX
            prevY <span style="color: #333333">=</span> globalY
            prevZ <span style="color: #333333">=</span> globalZ

        ax<span style="color: #333333">.</span>set_xlabel(<span style="background-color: #fff0f0">&#39;X&#39;</span>)
        ax<span style="color: #333333">.</span>set_ylabel(<span style="background-color: #fff0f0">&#39;Y&#39;</span>)
        ax<span style="color: #333333">.</span>set_zlabel(<span style="background-color: #fff0f0">&#39;Z&#39;</span>)
        ax<span style="color: #333333">.</span>set_title(<span style="background-color: #fff0f0">&#39;3D Test&#39;</span>)

        plt<span style="color: #333333">.</span>show()
parseFile(<span style="color: #007020">str</span>(sys<span style="color: #333333">.</span>argv[<span style="color: #0000DD; font-weight: bold">1</span>]))
</pre></td></tr></table></div>
<h2><strong><center>gcode_parser.py<br /></center></strong><br /></h2>
<!-- End of gcode_parser.py-->
						</div>
					</div>
					</div>

					<div class="yui-gf">
						<div class="yui-u first">
							<h2>Contact</h2>
						</div>
						<div class="yui-u">
						  <p> Jay Fetter </p>
						  <p>jdf258@cornell.edu </p>
						</div>
					</div>
					</div>

				</div><!--// .yui-b -->
			</div><!--// yui-main -->
		</div><!--// bd -->

		<div id="ft">
			<p><a href="http://validator.w3.org/check?uri=referer"><img src=
			"images/w3chatered.gif" title="W3C+Hates+Me" alt="W3C+Hates+Me"
			width="80" height="15" /></a>
			<a href="http://jigsaw.w3.org/css-validator/check/referer"><img src=
			"images/css_copy.gif" title="Valid+CSS%21" alt="Valid+CSS%21"
			width="80" height="15" /></a>
			<img src="images/code.gif" title="Handcrafted with sweat and blood" alt="Handcrafted with sweat and blood" width="80" height="15" />
			<img src="images/anybrowser.gif" title="Run Any Browser Any OS" alt="Runs on Any Browser Any OS" width="80" height="15" /></p>
			<br />
		</div><!--// footer -->

	</div><!-- // inner -->


</div><!--// doc -->


</body>
</html>
